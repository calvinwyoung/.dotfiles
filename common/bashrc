#!/usr/bin/env bash

# Check for an interactive session
[ -z "$PS1" ] && return

# Ignore duplicates in bash_history
HISTCONTROL=ignoreboth

# Ignore these commands in history file
HISTIGNORE=ls:ll:la:pwd:exit:df:clear

# Append to the bash history file, rather than overwriting it
shopt -s histappend

# Disable Ctrl+S to suspend terminal
stty -ixon

# Enable iTerm2 integration if appropriate
[ -f "$HOME/.iterm2_shell_integration.bash" ] && source "$HOME/.iterm2_shell_integration.bash"

# ------------------------
# Environment variables
# ------------------------

# Integrate QT applications with GTK theme
export GTK2_RC_FILES="$HOME/.gtkrc-2.0"

# Set default text editor
export EDITOR="vim"

# Set PATH to include user's bin dir if it exists
if [ -d "$HOME/.bin" ]; then
    export PATH="$HOME/.bin:$PATH"
fi

# Add Homebrew packages to PATH.
if [ `uname` == "Darwin" ]; then
    export PATH="/usr/local/opt/coreutils/libexec/gnubin:/usr/local/sbin:$PATH"
fi

# Enable bash completion
if [ `uname` == "Darwin" ]; then
    [ -f /usr/local/etc/bash_completion ] && source /usr/local/etc/bash_completion
else
    [ -f /etc/bash_completion ] && source /etc/bash_completion
fi

# Set up Go.
export GOPATH=$HOME/Code/go
export PATH="$PATH:$GOPATH/bin"

# Set up RVM. Note that RVM wants its `bin` folder to appear as the first entry
# in the $PATH, so this must come after everything else that modifies $PATH.
if [ -d "$HOME/.rvm/bin" ]; then
    export PATH="$HOME/.rvm/bin:$PATH"
fi
if [ -s "$HOME/.rvm/scripts/rvm" ]; then
    # Load RVM into a shell session *as a function*
    source "$HOME/.rvm/scripts/rvm"
fi

# For virtualenv, which gets installed in different places depending on whether
# we're on Linux or OSX. Also enable autoenv for activating virtualenvs
# automagically. Note that for some reason autoenv needs to come *after* the RVM
# commands to work properly.
export WORKON_HOME=$HOME/.virtualenvs
export VIRTUAL_ENV_DISABLE_PROMPT=1
if [ -f /usr/bin/virtualenvwrapper.sh ]; then
    source /usr/bin/virtualenvwrapper.sh
elif [ -f /usr/local/bin/virtualenvwrapper.sh ]; then
    source /usr/local/bin/virtualenvwrapper.sh
fi
source $(brew --prefix autoenv)/activate.sh

# Set up Java.
export JAVA_HOME=$(/usr/libexec/java_home)

# ------------------------
# Prompt
# ------------------------
# Virtualenv prompt info
function virtualenv_prompt_info {
    [[ $VIRTUAL_ENV ]] && echo "[$(basename $VIRTUAL_ENV)] "
}

# Git prompt info
function parse_git_dirty {
  [[ -n $(git status -s ${SUBMODULE_SYNTAX}  2> /dev/null) ]] && echo "*"
}
function git_prompt_info {
  ref=$(git symbolic-ref HEAD 2> /dev/null) || \
  ref=$(git rev-parse --short HEAD 2> /dev/null) || return
  echo "(${ref#refs/heads/}$(parse_git_dirty))"
}

# Color bash prompt
export PS1='\[\033[01;32m\]\u@\h\[\033[00m\] \[\033[01;34m\]\w\[\033[00m\] $(virtualenv_prompt_info)\[\033[01;33m\]$(git_prompt_info)\[\033[00m\]
$ '
export SUDO_PS1='\[\033[01;31;40m\]\u@\h \[\033[00m\]\w
$ '

# ------------------------
# Aliases
# ------------------------
# Must use the `--` operator in order to bind an alias to `-`
alias -- -="cd -"
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias ls="ls -F --color=auto"
alias la="ls -alh"
alias grep="grep --color=auto"
alias e="emacsclient -t"
alias ipython="ipython --colors Linux"

alias dup="source /Applications/Docker/Docker\ Quickstart\ Terminal.app/Contents/Resources/Scripts/start.sh"
alias di="docker images"
alias dip="docker-machine ip"
function dclean() {
    docker rm -v $(docker ps --all --quiet --filter "status=exited")
    docker rmi $(docker images --filter "dangling=true" --quiet)
}

# Colorize man pages.
man() {
    env \
	LESS_TERMCAP_md=$'\e[1;34m' \
	LESS_TERMCAP_me=$'\e[0m' \
	LESS_TERMCAP_se=$'\e[0m' \
	LESS_TERMCAP_so=$'\e[1;40;92m' \
	LESS_TERMCAP_ue=$'\e[0m' \
	LESS_TERMCAP_us=$'\e[1;32m' \
	man "$@"
}
